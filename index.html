<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM - Gesti√≥n de Clientes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --accent: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --background: #f5f7fa;
            --card-bg: #ffffff;
            --text: #333333;
            --text-secondary: #7f8c8d;
            --border: #dcdde1;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --background: #1a1a1a;
            --card-bg: #2d2d2d;
            --text: #f5f5f5;
            --text-secondary: #bdc3c7;
            --border: #404040;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        h1, h2, h3, h4 {
            color: var(--primary);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            font-size: 24px;
            color: var(--primary);
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        button:hover {
            opacity: 0.9;
        }

        button.secondary {
            background-color: var(--secondary);
        }

        button.accent {
            background-color: var(--accent);
        }

        button.warning {
            background-color: var(--warning);
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background-color: var(--card-bg);
            color: var(--text);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .chip {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 5px;
            margin-bottom: 5px;
            color: white;
        }

        .status-prospecto { background-color: #3498db; }
        .status-interesado { background-color: #2ecc71; }
        .status-pendiente { background-color: #f39c12; }
        .status-instalar { background-color: #9b59b6; }
        .status-transito { background-color: #34495e; }
        .status-trabajando { background-color: #8e44ad; }
        .status-instalada { background-color: #27ae60; }
        .status-perdida { background-color: #e74c3c; }
        .status-cobertura { background-color: #7f8c8d; }
        .status-factibilidad { background-color: #d35400; }
        .status-planta { background-color: #16a085; }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text);
        }

        footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            border-top: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .client-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .client-table th, .client-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .client-table th {
            background-color: var(--primary);
            color: white;
        }

        .client-table tr:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }

        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .summary-card h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .summary-card .number {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-modal {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom: 3px solid var(--primary);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .whatsapp-btn {
            background-color: #25D366;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
        }

        .whatsapp-message-preview {
            background-color: #dcf8c6;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-line;
            line-height: 1.5;
        }

        .price-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            border-left: 4px solid var(--primary);
        }

        .price-info h4 {
            margin-bottom: 10px;
            color: var(--primary);
        }

        .price-info table {
            width: 100%;
            border-collapse: collapse;
        }

        .price-info th, .price-info td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .price-info th {
            background-color: #e9ecef;
        }

        .commission-paid {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .paste-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }

        .paste-modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
        }

        .paste-help {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
        }

        .management-section {
            margin-bottom: 30px;
        }

        .management-list {
            list-style: none;
            margin-top: 15px;
        }

        .management-list li {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .management-list li:last-child {
            border-bottom: none;
        }

        .management-actions {
            display: flex;
            gap: 5px;
        }

        .management-actions button {
            padding: 5px 10px;
            font-size: 12px;
        }

        .gsheets-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .gsheets-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .gsheets-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            background-color: #e9ecef;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text);
            cursor: pointer;
        }

        .make-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e9;
            border-radius: 8px;
            border-left: 4px solid #4caf50;
        }

        .make-steps {
            margin-top: 15px;
            padding-left: 20px;
        }

        .make-steps li {
            margin-bottom: 10px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            color: white;
            z-index: 10000;
            display: none;
        }

        .notification.success {
            background-color: #4caf50;
        }

        .notification.error {
            background-color: #f44336;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .controls, .filters {
                flex-direction: column;
            }
            
            .client-table {
                display: block;
                overflow-x: auto;
            }

            .mobile-menu-btn {
                display: block;
            }

            .controls {
                display: none;
                flex-direction: column;
            }

            .controls.active {
                display: flex;
            }

            .filters {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
            }

            .tab {
                padding: 8px 12px;
                font-size: 14px;
            }

            button {
                width: 100%;
                justify-content: center;
            }

            .management-actions {
                flex-direction: column;
            }

            .whatsapp-btn {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>
    
    <div class="container">
        <header>
            <div class="logo">
                <button class="mobile-menu-btn" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
                <span class="logo-icon"><i class="fas fa-users"></i></span>
                <h1>CRM - Gesti√≥n de Clientes</h1>
            </div>
            <div>
                <button class="theme-toggle" id="themeToggle"><i class="fas fa-moon"></i></button>
            </div>
        </header>

        <div class="controls" id="mainControls">
            <button id="newClientBtn"><i class="fas fa-plus"></i> Nuevo Cliente</button>
            <button id="syncBtn" class="secondary"><i class="fas fa-sync"></i> Sincronizar con Google Sheets</button>
            <button id="exportBtn" class="warning"><i class="fas fa-download"></i> Exportar Datos</button>
            <button id="summaryBtn"><i class="fas fa-chart-bar"></i> Resumen Mensual</button>
            <button id="manageSellersBtn"><i class="fas fa-user-tie"></i> Gestionar Vendedores</button>
            <button id="manageServicesBtn"><i class="fas fa-concierge-bell"></i> Gestionar Servicios</button>
            <button id="managePlansBtn"><i class="fas fa-list-alt"></i> Gestionar Planes</button>
            <button id="makeConfigBtn"><i class="fas fa-cloud"></i> Configurar Make.com</button>
        </div>

        <div class="summary-cards">
            <div class="summary-card">
                <h3>Clientes Totales</h3>
                <div class="number" id="totalClients">0</div>
            </div>
            <div class="summary-card">
                <h3>Por Instalar</h3>
                <div class="number" id="pendingInstall">0</div>
            </div>
            <div class="summary-card">
                <h3>Instalaciones Este Mes</h3>
                <div class="number" id="monthlyInstall">0</div>
            </div>
            <div class="summary-card">
                <h3>Comisiones Pendientes</h3>
                <div class="number" id="pendingCommissions">$0</div>
            </div>
            <div class="summary-card">
                <h3>Comisiones Pagadas</h3>
                <div class="number" id="paidCommissions">$0</div>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label for="statusFilter">Filtrar por Estado</label>
                <select id="statusFilter">
                    <option value="">Todos los estados</option>
                    <option value="prospecto">Prospecto</option>
                    <option value="interesado">Interesado</option>
                    <option value="pendiente">Pendiente de enviar documentos</option>
                    <option value="instalar">Pendiente de instalar</option>
                    <option value="transito">T√©cnico en tr√°nsito</option>
                    <option value="trabajando">T√©cnico trabajando</option>
                    <option value="instalada">Instalada</option>
                    <option value="perdida">Perdida/Cancelada</option>
                    <option value="cobertura">Fuera de cobertura</option>
                    <option value="factibilidad">Factibilidad</option>
                    <option value="planta">Planta Externa</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="sellerFilter">Filtrar por Vendedor</label>
                <select id="sellerFilter">
                    <option value="">Todos los vendedores</option>
                    <!-- Los vendedores se cargar√°n din√°micamente -->
                </select>
            </div>
            <div class="filter-group">
                <label for="dateFilter">Filtrar por Mes</label>
                <select id="dateFilter">
                    <option value="">Todos los meses</option>
                    <option value="2025-06">Junio 2025</option>
                    <option value="2025-07">Julio 2025</option>
                    <option value="2025-08">Agosto 2025</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="commissionFilter">Filtrar por Comisi√≥n</label>
                <select id="commissionFilter">
                    <option value="">Todas</option>
                    <option value="pendiente">Pendientes de pago</option>
                    <option value="pagada">Pagadas</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="searchFilter">Buscar</label>
                <input type="text" id="searchFilter" placeholder="Nombre, tel√©fono, cuenta...">
            </div>
        </div>

        <div class="card">
            <h2>Lista de Clientes</h2>
            <div class="table-responsive">
                <table class="client-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Tel√©fono</th>
                            <th>Estado</th>
                            <th>Vendedor</th>
                            <th>Fecha Captura</th>
                            <th>Plan</th>
                            <th>Comisi√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="clientsTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center;">Cargando clientes...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Secci√≥n de Make.com -->
        <div class="management-section" id="makeSection" style="display: none;">
            <div class="card">
                <h2>Integraci√≥n con Make.com</h2>
                <div class="make-section">
                    <p>Con Make.com (antes Integromat) puedes sincronizar autom√°ticamente tus datos con Google Sheets sin necesidad de programaci√≥n compleja.</p>
                    
                    <h3>Configuraci√≥n Actual</h3>
                    <p>Webhook URL: <strong id="currentWebhookUrl">https://hook.eu2.make.com/bnhk5ny1viui7oltga2w8ghg9of1vrmj</strong></p>
                    <p>Estado: <strong id="makeStatusText">Conectado</strong></p>
                    
                    <div class="form-group">
                        <label for="makeWebhookUrl">URL del Webhook de Make.com (si necesitas cambiarlo)</label>
                        <input type="url" id="makeWebhookUrl" placeholder="https://hook.make.com/..." value="https://hook.eu2.make.com/bnhk5ny1viui7oltga2w8ghg9of1vrmj">
                    </div>
                    
                    <button id="saveMakeConfigBtn" class="secondary"><i class="fas fa-save"></i> Actualizar Configuraci√≥n</button>
                </div>
                
                <h3 style="margin-top: 20px;">Sincronizaci√≥n</h3>
                <div class="gsheets-form">
                    <button id="testMakeBtn"><i class="fas fa-bolt"></i> Probar Conexi√≥n</button>
                    <button id="syncMakeBtn" class="secondary"><i class="fas fa-sync-alt"></i> Sincronizar Ahora</button>
                    <button id="importFromSheetsBtn" class="warning"><i class="fas fa-file-import"></i> Importar desde Sheets</button>
                </div>
            </div>
        </div>

        <!-- Secciones de gesti√≥n -->
        <div class="management-section" id="sellersSection" style="display: none;">
            <div class="card">
                <h2>Gesti√≥n de Vendedores</h2>
                <div class="form-group">
                    <label for="sellerName">Nombre del Vendedor</label>
                    <input type="text" id="sellerName" placeholder="Nombre completo">
                </div>
                <div class="form-group">
                    <label for="sellerPhone">Tel√©fono</label>
                    <input type="tel" id="sellerPhone" placeholder="Tel√©fono de contacto">
                </div>
                <button id="addSellerBtn" class="secondary"><i class="fas fa-plus"></i> Agregar Vendedor</button>
                
                <h3 style="margin-top: 20px;">Lista de Vendedores</h3>
                <ul class="management-list" id="sellersList">
                    <!-- Los vendedores se cargar√°n din√°micamente -->
                </ul>
            </div>
        </div>

        <div class="management-section" id="servicesSection" style="display: none;">
            <div class="card">
                <h2>Gesti√≥n de Servicios</h2>
                <div class="form-group">
                    <label for="serviceName">Nombre del Servicio</label>
                    <input type="text" id="serviceName" placeholder="Nombre del servicio">
                </div>
                <button id="addServiceBtn" class="secondary"><i class="fas fa-plus"></i> Agregar Servicio</button>
                
                <h3 style="margin-top: 20px;">Lista de Servicios</h3>
                <ul class="management-list" id="servicesList">
                    <!-- Los servicios se cargar√°n din√°micamente -->
                </ul>
            </div>
        </div>

        <div class="management-section" id="plansSection" style="display: none;">
            <div class="card">
                <h2>Gesti√≥n de Planes</h2>
                <div class="form-group">
                    <label for="planName">Nombre del Plan</label>
                    <input type="text" id="planName" placeholder="Ej: 100 Mbps">
                </div>
                <div class="form-group">
                    <label for="planSpeed">Velocidad (Mbps)</label>
                    <input type="number" id="planSpeed" placeholder="100">
                </div>
                <div class="form-group">
                    <label for="planServiceType">Tipo de Servicio</label>
                    <select id="planServiceType">
                        <!-- Se cargar√° din√°micamente -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="planFastPrice">Precio Pronto Pago</label>
                    <input type="number" id="planFastPrice" placeholder="460">
                </div>
                <div class="form-group">
                    <label for="planListPrice">Precio de Lista</label>
                    <input type="number" id="planListPrice" placeholder="510">
                </div>
                <div class="form-group">
                    <label for="planCommission">Comisi√≥n</label>
                    <input type="number" id="planCommission" placeholder="60">
                </div>
                <button id="addPlanBtn" class="secondary"><i class="fas fa-plus"></i> Agregar Plan</button>
                
                <h3 style="margin-top: 20px;">Lista de Planes</h3>
                <ul class="management-list" id="plansList">
                    <!-- Los planes se cargar√°n din√°micamente -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Modal para pegar informaci√≥n -->
    <div class="paste-modal" id="pasteModal">
        <div class="paste-modal-content">
            <span class="close-modal" id="closePasteModal">&times;</span>
            <h2>Pegar Informaci√≥n del Cliente</h2>
            
            <div class="form-group">
                <label for="pasteText">Pega aqu√≠ la informaci√≥n del cliente:</label>
                <textarea id="pasteText" placeholder="Ejemplo:
Aurora Guerrero Zapata

13/Agosto/1978

auroraguerrero046@gmail.com

8136274272

Tenerife 415
Entre Le√≥n de Francia y florencia 
Paseo de las flores
Apodaca

Plan contratado
100 MEGAS + Canales $600 mensual" rows="10"></textarea>
            </div>
            
            <div class="paste-help">
                <p><strong>Formato esperado:</strong></p>
                <p>Nombre completo</p>
                <p>Fecha de nacimiento (opcional)</p>
                <p>Correo electr√≥nico</p>
                <p>Tel√©fono</p>
                <p>Direcci√≥n (varias l√≠neas)</p>
                <p>Plan contratado</p>
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button id="processPasteBtn" class="secondary">Procesar Informaci√≥n</button>
                <button id="cancelPasteBtn">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para nuevo cliente -->
    <div class="modal" id="clientModal">
        <div class="modal-content">
            <span class="close-modal" id="closeModal">&times;</span>
            <h2 id="modalTitle">Nuevo Cliente</h2>
            
            <div class="tabs">
                <div class="tab active" data-tab="info">Informaci√≥n B√°sica</div>
                <div class="tab" data-tab="sale">Datos de Venta</div>
                <div class="tab" data-tab="additional">Informaci√≥n Adicional</div>
            </div>
            
            <form id="clientForm">
                <div class="tab-content active" id="info-tab">
                    <div class="form-group">
                        <label for="clientName">Nombre del Cliente *</label>
                        <input type="text" id="clientName" required>
                    </div>
                    <div class="form-group">
                        <label for="clientPhone">Tel√©fono/WhatsApp *</label>
                        <input type="tel" id="clientPhone" required>
                    </div>
                    <div class="form-group">
                        <label for="clientAdditionalPhone">Tel√©fono Adicional</label>
                        <input type="tel" id="clientAdditionalPhone">
                    </div>
                    <div class="form-group">
                        <label for="clientEmail">Correo Electr√≥nico</label>
                        <input type="email" id="clientEmail">
                    </div>
                    <div class="form-group">
                        <label for="clientAddress">Direcci√≥n</label>
                        <textarea id="clientAddress"></textarea>
                    </div>
                </div>
                
                <div class="tab-content" id="sale-tab">
                    <div class="form-group">
                        <label for="clientStatus">Estado *</label>
                        <select id="clientStatus" required>
                            <option value="prospecto">Prospecto</option>
                            <option value="interesado">Interesado</option>
                            <option value="pendiente">Pendiente de enviar documentos</option>
                            <option value="instalar">Pendiente de instalar</option>
                            <option value="transito">T√©cnico en tr√°nsito</option>
                            <option value="trabajando">T√©cnico trabajando</option>
                            <option value="instalada">Instalada</option>
                            <option value="perdida">Perdida/Cancelada</option>
                            <option value="cobertura">Fuera de cobertura</option>
                            <option value="factibilidad">Factibilidad</option>
                            <option value="planta">Planta Externa</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="serviceType">Tipo de Servicio *</label>
                        <select id="serviceType" required>
                            <option value="">Seleccionar tipo de servicio</option>
                            <!-- Los servicios se cargar√°n din√°micamente -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="clientPlan">Plan Vendido *</label>
                        <select id="clientPlan" required>
                            <option value="">Seleccionar plan</option>
                            <!-- Los planes se cargar√°n din√°micamente -->
                        </select>
                    </div>
                    
                    <div class="price-info" id="priceInfo" style="display: none;">
                        <h4>Informaci√≥n de Precios</h4>
                        <table>
                            <tr>
                                <th>Plan</th>
                                <th>Pago Puntual</th>
                                <th>Precio de Lista</th>
                                <th>Comisi√≥n</th>
                            </tr>
                            <tbody id="priceInfoBody">
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="priceFields" style="display: none;">
                        <div class="form-group">
                            <label for="clientListPrice">Precio de Lista</label>
                            <input type="number" id="clientListPrice" readonly>
                        </div>
                        <div class="form-group">
                            <label for="clientFastPrice">Precio Pronto Pago</label>
                            <input type="number" id="clientFastPrice" readonly>
                        </div>
                        <div class="form-group">
                            <label for="clientCommission">Comisi√≥n Ganada</label>
                            <input type="number" id="clientCommission" readonly>
                        </div>
                        
                        <div class="commission-paid" id="commissionPaidSection" style="display: none;">
                            <input type="checkbox" id="commissionPaid">
                            <label for="commissionPaid">¬øComisi√≥n ya pagada?</label>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="additional-tab">
                    <div class="form-group">
                        <label for="clientAccount">N√∫mero de Cuenta</label>
                        <input type="text" id="clientAccount">
                    </div>
                    <div class="form-group">
                        <label for="clientReference">N√∫mero de Referencia de Pago</label>
                        <input type="text" id="clientReference">
                    </div>
                    <div class="form-group">
                        <label for="clientCaptureDate">Fecha de Captura</label>
                        <input type="date" id="clientCaptureDate">
                    </div>
                    <div class="form-group">
                        <label for="clientInstallDate">Fecha de Instalado</label>
                        <input type="date" id="clientInstallDate">
                    </div>
                    <div class="form-group">
                        <label for="clientDistrict">¬øEs Distrito?</label>
                        <select id="clientDistrict">
                            <option value="no">No</option>
                            <option value="si">S√≠</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="clientSeller">Vendedor</label>
                        <select id="clientSeller">
                            <!-- Se cargar√° din√°micamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="clientComments">Comentarios</label>
                        <textarea id="clientComments"></textarea>
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: flex; justify-content: space-between;">
                    <button type="button" id="prevTab" class="secondary"><i class="fas fa-arrow-left"></i> Anterior</button>
                    <button type="button" id="nextTab" class="secondary">Siguiente <i class="fas fa-arrow-right"></i></button>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button type="submit" id="saveClientBtn">Guardar Cliente</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para recordatorio de WhatsApp -->
    <div class="modal" id="whatsappModal">
        <div class="modal-content">
            <span class="close-modal" id="closeWhatsappModal">&times;</span>
            <h2>Enviar Recordatorio por WhatsApp</h2>
            
            <div class="form-group">
                <label for="whatsappTemplate">Plantilla de Mensaje</label>
                <select id="whatsappTemplate">
                    <option value="pago">Recordatorio de Pago</option>
                    <option value="instalacion">Recordatorio de Instalaci√≥n</option>
                    <option value="seguimiento">Seguimiento Post-Venta</option>
                </select>
            </div>
            
            <div class="whatsapp-message-preview" id="whatsappPreview">
                üëã Hola [Nombre], buen d√≠a.

                üìå Te comparto tu referencia de pago en OXXO:

                üí≥ Referencia: [Referencia]

                ‚è≥ Desde hoy cuentas con 25 a 28 d√≠as para tu siguiente pago dentro de tu precio de promoci√≥n.

                ‚ùìCualquier duda, m√°ndame mensaje y te ayudo al momento.

                üôè Gracias por tu preferencia.
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button id="sendWhatsappBtn" class="secondary"><i class="fab fa-whatsapp"></i> Abrir WhatsApp</button>
            </div>
        </div>
    </div>

    <footer>
        <p>CRM - Gesti√≥n de Clientes &copy; 2023 | Conectado con Make.com y Google Sheets</p>
    </footer>

    <script>
        // URL de Make.com Webhook
        const MAKE_WEBHOOK_URL = 'https://hook.eu2.make.com/bnhk5ny1viui7oltga2w8ghg9of1vrmj';
        
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos DOM
            const themeToggle = document.getElementById('themeToggle');
            const newClientBtn = document.getElementById('newClientBtn');
            const syncBtn = document.getElementById('syncBtn');
            const exportBtn = document.getElementById('exportBtn');
            const summaryBtn = document.getElementById('summaryBtn');
            const clientModal = document.getElementById('clientModal');
            const closeModal = document.getElementById('closeModal');
            const clientForm = document.getElementById('clientForm');
            const saveClientBtn = document.getElementById('saveClientBtn');
            const clientsTableBody = document.getElementById('clientsTableBody');
            const statusFilter = document.getElementById('statusFilter');
            const sellerFilter = document.getElementById('sellerFilter');
            const dateFilter = document.getElementById('dateFilter');
            const commissionFilter = document.getElementById('commissionFilter');
            const searchFilter = document.getElementById('searchFilter');
            const whatsappModal = document.getElementById('whatsappModal');
            const closeWhatsappModal = document.getElementById('closeWhatsappModal');
            const sendWhatsappBtn = document.getElementById('sendWhatsappBtn');
            const prevTabBtn = document.getElementById('prevTab');
            const nextTabBtn = document.getElementById('nextTab');
            const whatsappTemplate = document.getElementById('whatsappTemplate');
            const whatsappPreview = document.getElementById('whatsappPreview');
            const serviceType = document.getElementById('serviceType');
            const clientPlan = document.getElementById('clientPlan');
            const clientStatus = document.getElementById('clientStatus');
            const priceInfo = document.getElementById('priceInfo');
            const priceInfoBody = document.getElementById('priceInfoBody');
            const priceFields = document.getElementById('priceFields');
            const clientListPrice = document.getElementById('clientListPrice');
            const clientFastPrice = document.getElementById('clientFastPrice');
            const clientCommission = document.getElementById('clientCommission');
            const commissionPaid = document.getElementById('commissionPaid');
            const commissionPaidSection = document.getElementById('commissionPaidSection');
            const pasteModal = document.getElementById('pasteModal');
            const closePasteModal = document.getElementById('closePasteModal');
            const pasteText = document.getElementById('pasteText');
            const processPasteBtn = document.getElementById('processPasteBtn');
            const cancelPasteBtn = document.getElementById('cancelPasteBtn');
            const clientAddress = document.getElementById('clientAddress');
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mainControls = document.getElementById('mainControls');
            const manageSellersBtn = document.getElementById('manageSellersBtn');
            const manageServicesBtn = document.getElementById('manageServicesBtn');
            const managePlansBtn = document.getElementById('managePlansBtn');
            const makeConfigBtn = document.getElementById('makeConfigBtn');
            const sellersSection = document.getElementById('sellersSection');
            const servicesSection = document.getElementById('servicesSection');
            const plansSection = document.getElementById('plansSection');
            const makeSection = document.getElementById('makeSection');
            const sellerName = document.getElementById('sellerName');
            const sellerPhone = document.getElementById('sellerPhone');
            const addSellerBtn = document.getElementById('addSellerBtn');
            const sellersList = document.getElementById('sellersList');
            const serviceName = document.getElementById('serviceName');
            const addServiceBtn = document.getElementById('addServiceBtn');
            const servicesList = document.getElementById('servicesList');
            const planName = document.getElementById('planName');
            const planSpeed = document.getElementById('planSpeed');
            const planServiceType = document.getElementById('planServiceType');
            const planFastPrice = document.getElementById('planFastPrice');
            const planListPrice = document.getElementById('planListPrice');
            const planCommission = document.getElementById('planCommission');
            const addPlanBtn = document.getElementById('addPlanBtn');
            const plansList = document.getElementById('plansList');
            const makeWebhookUrl = document.getElementById('makeWebhookUrl');
            const saveMakeConfigBtn = document.getElementById('saveMakeConfigBtn');
            const testMakeBtn = document.getElementById('testMakeBtn');
            const syncMakeBtn = document.getElementById('syncMakeBtn');
            const importFromSheetsBtn = document.getElementById('importFromSheetsBtn');
            const currentWebhookUrl = document.getElementById('currentWebhookUrl');
            const makeStatusText = document.getElementById('makeStatusText');
            const notification = document.getElementById('notification');
            
            // Tabla de precios (se cargar√° din√°micamente)
            let pricingTable = {};
            
            // Variables de estado
            let clients = [];
            let sellers = [];
            let services = [];
            let plans = [];
            let currentClientId = null;
            let currentTab = 'info';
            let currentClientForWhatsapp = null;
            let currentEditingSeller = null;
            let currentEditingService = null;
            let currentEditingPlan = null;
            let makeWebhook = MAKE_WEBHOOK_URL;
            let lastSyncStatus = '';
            
            // Plantillas de mensajes de WhatsApp
            const whatsappTemplates = {
                pago: `üëã Hola [Nombre], buen d√≠a.

üìå Te comparto tu referencia de pago en OXXO:

üí≥ Referencia: [Referencia]

‚è≥ Desde hoy cuentas con 25 a 28 d√≠as para tu siguiente pago dentro de tu precio de promoci√≥n.

‚ùìCualquier duda, m√°ndame mensaje y te ayudo al momento.

üôè Gracias por tu preferencia.`,

                instalacion: `üëã Hola [Nombre], buen d√≠a.

üìÖ Te confirmo que tu instalaci√≥n est√° programada para la fecha acordada.

üõ†Ô∏è Nuestro t√©cnico se pondr√° en contacto contigo antes de llegar.

‚ùìCualquier duda, no dudes en contactarme.

üôè Gracias por confiar en nosotros.`,

                seguimiento: `üëã Hola [Nombre], espero que est√©s bien.

üìû Te contacto para saber c√≥mo ha sido tu experiencia con nuestro servicio hasta el momento.

‚≠ê Nos importa mucho tu satisfacci√≥n y estamos para resolver cualquier inquietud.

üôè ¬°Gracias por ser parte de nuestra comunidad!`
            };
            
            // Inicializar
            initializeApp();
            
            // Alternar men√∫ m√≥vil
            mobileMenuBtn.addEventListener('click', function() {
                mainControls.classList.toggle('active');
            });
            
            // Alternar tema claro/oscuro
            themeToggle.addEventListener('click', function() {
                document.body.setAttribute('data-theme', 
                    document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
                themeToggle.innerHTML = document.body.getAttribute('data-theme') === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            });
            
            // Cambiar plantilla de WhatsApp
            whatsappTemplate.addEventListener('change', function() {
                updateWhatsappPreview();
            });
            
            // Cambiar tipo de servicio
            serviceType.addEventListener('change', function() {
                updatePriceInfo();
                updatePlanOptions();
            });
            
            // Cambiar plan
            clientPlan.addEventListener('change', function() {
                updatePriceInfo();
            });
            
            // Cambiar estado
            clientStatus.addEventListener('change', function() {
                togglePriceFields();
            });
            
            // Abrir modal para nuevo cliente
            newClientBtn.addEventListener('click', function() {
                // Mostrar modal para pegar informaci√≥n
                pasteModal.style.display = 'flex';
                pasteText.value = '';
            });
            
            // Cerrar modal de pegar
            closePasteModal.addEventListener('click', function() {
                pasteModal.style.display = 'none';
            });
            
            // Cancelar pegado
            cancelPasteBtn.addEventListener('click', function() {
                pasteModal.style.display = 'none';
            });
            
            // Procesar texto pegado
            processPasteBtn.addEventListener('click', function() {
                processPastedText();
            });
            
            // Cerrar modal
            closeModal.addEventListener('click', function() {
                clientModal.style.display = 'none';
            });
            
            // Cerrar modal de WhatsApp
            closeWhatsappModal.addEventListener('click', function() {
                whatsappModal.style.display = 'none';
            });
            
            // Navegaci√≥n entre pesta√±as
            prevTabBtn.addEventListener('click', function() {
                navigateTabs('prev');
            });
            
            nextTabBtn.addEventListener('click', function() {
                navigateTabs('next');
            });
            
            // Guardar cliente
            clientForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveClient();
            });
            
            // Sincronizar con Google Sheets a trav√©s de Make.com
            syncBtn.addEventListener('click', function() {
                syncWithMake();
            });
            
            // Exportar datos
            exportBtn.addEventListener('click', function() {
                exportData();
            });
            
            // Filtrar clientes
            statusFilter.addEventListener('change', filterClients);
            sellerFilter.addEventListener('change', filterClients);
            dateFilter.addEventListener('change', filterClients);
            commissionFilter.addEventListener('change', filterClients);
            searchFilter.addEventListener('input', filterClients);
            
            // Enviar mensaje por WhatsApp
            sendWhatsappBtn.addEventListener('click', function() {
                if (currentClientForWhatsapp) {
                    const client = clients.find(c => c.id == currentClientForWhatsapp);
                    if (client) {
                        const templateType = whatsappTemplate.value;
                        let message = whatsappTemplates[templateType];
                        
                        // Personalizar el mensaje
                        message = message.replace('[Nombre]', client.name);
                        message = message.replace('[Referencia]', client.reference || 'N/A');
                        
                        const encodedMessage = encodeURIComponent(message);
                        window.open(`https://wa.me/${cleanPhoneNumber(client.phone)}?text=${encodedMessage}`, '_blank');
                    }
                }
                whatsappModal.style.display = 'none';
            });
            
            // Gesti√≥n de vendedores
            manageSellersBtn.addEventListener('click', function() {
                hideAllSections();
                sellersSection.style.display = 'block';
                loadSellersList();
            });
            
            addSellerBtn.addEventListener('click', function() {
                addOrUpdateSeller();
            });
            
            // Gesti√≥n de servicios
            manageServicesBtn.addEventListener('click', function() {
                hideAllSections();
                servicesSection.style.display = 'block';
                loadServicesList();
            });
            
            addServiceBtn.addEventListener('click', function() {
                addOrUpdateService();
            });
            
            // Gesti√≥n de planes
            managePlansBtn.addEventListener('click', function() {
                hideAllSections();
                plansSection.style.display = 'block';
                loadPlansList();
            });
            
            addPlanBtn.addEventListener('click', function() {
                addOrUpdatePlan();
            });
            
            // Configuraci√≥n de Make.com
            makeConfigBtn.addEventListener('click', function() {
                hideAllSections();
                makeSection.style.display = 'block';
                loadMakeConfig();
            });
            
            saveMakeConfigBtn.addEventListener('click', function() {
                saveMakeConfig();
            });
            
            testMakeBtn.addEventListener('click', function() {
                testMakeConnection();
            });
            
            syncMakeBtn.addEventListener('click', function() {
                syncWithMake();
            });
            
            importFromSheetsBtn.addEventListener('click', function() {
                importFromSheets();
            });
            
            // Funciones de inicializaci√≥n
            function initializeApp() {
                loadFromLocalStorage();
                loadSellers();
                loadServices();
                loadPlans();
                updatePricingTable();
                loadClients();
                setupTabs();
                
                // Cargar opciones de servicios y planes en los formularios
                updateServiceOptions();
                updatePlanOptions();
                updatePlanServiceTypeOptions();
            }
            
            function setupTabs() {
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        setActiveTab(this.getAttribute('data-tab'));
                    });
                });
            }
            
            function setActiveTab(tabName) {
                currentTab = tabName;
                
                // Actualizar pesta√±as
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
                
                // Actualizar contenido
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}-tab`).classList.add('active');
            }
            
            function navigateTabs(direction) {
                const tabs = ['info', 'sale', 'additional'];
                const currentIndex = tabs.indexOf(currentTab);
                
                if (direction === 'next' && currentIndex < tabs.length - 1) {
                    setActiveTab(tabs[currentIndex + 1]);
                } else if (direction === 'prev' && currentIndex > 0) {
                    setActiveTab(tabs[currentIndex - 1]);
                }
            }
            
            function loadSellers() {
                // Cargar vendedores en los filtros y formularios
                const sellerSelects = [sellerFilter, document.getElementById('clientSeller')];
                
                sellerSelects.forEach(select => {
                    select.innerHTML = '<option value="">Seleccionar vendedor</option>';
                    sellers.forEach(seller => {
                        const option = document.createElement('option');
                        option.value = seller.id;
                        option.textContent = seller.name;
                        select.appendChild(option);
                    });
                });
            }
            
            function loadServices() {
                // Cargar servicios en los formularios
                serviceType.innerHTML = '<option value="">Seleccionar tipo de servicio</option>';
                services.forEach(service => {
                    const option = document.createElement('option');
                        option.value = service.id;
                        option.textContent = service.name;
                        serviceType.appendChild(option);
                });
            }
            
            function loadPlans() {
                // Cargar planes en los formularios
                clientPlan.innerHTML = '<option value="">Seleccionar plan</option>';
                plans.forEach(plan => {
                    const option = document.createElement('option');
                    option.value = plan.id;
                    option.textContent = `${plan.name} (${plan.speed} Mbps)`;
                    clientPlan.appendChild(option);
                });
            }
            
            function updatePlanServiceTypeOptions() {
                // Cargar servicios en el formulario de planes
                planServiceType.innerHTML = '<option value="">Seleccionar tipo de servicio</option>';
                services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.id;
                    option.textContent = service.name;
                    planServiceType.appendChild(option);
                });
            }
            
            function updateServiceOptions() {
                // Actualizar opciones de servicios en todos los formularios
                loadServices();
            }
            
            function updatePlanOptions() {
                // Actualizar opciones de planes basado en el servicio seleccionado
                const selectedService = serviceType.value;
                clientPlan.innerHTML = '<option value="">Seleccionar plan</option>';
                
                plans.forEach(plan => {
                    if (!selectedService || plan.serviceType == selectedService) {
                        const option = document.createElement('option');
                        option.value = plan.id;
                        option.textContent = `${plan.name} (${plan.speed} Mbps)`;
                        clientPlan.appendChild(option);
                    }
                });
            }
            
            function updatePricingTable() {
                // Construir la tabla de precios a partir de los planes
                pricingTable = {};
                
                services.forEach(service => {
                    pricingTable[service.id] = {};
                });
                
                plans.forEach(plan => {
                    if (pricingTable[plan.serviceType]) {
                        pricingTable[plan.serviceType][plan.id] = {
                            fastPrice: plan.fastPrice,
                            listPrice: plan.listPrice,
                            commission: plan.commission
                        };
                    }
                });
            }
            
            function loadClients() {
                // Datos de ejemplo para junio, julio y agosto 2025
                if (clients.length === 0) {
                    clients = [
                        {
                            id: 1,
                            name: 'Juan Mart√≠nez',
                            phone: '5551234567',
                            email: 'juan@example.com',
                            status: 'instalada',
                            seller: '1',
                            captureDate: '2025-06-15',
                            installDate: '2025-06-20',
                            account: '123456',
                            reference: 'REF123456789',
                            serviceType: '1',
                            plan: '1',
                            listPrice: 620,
                            fastPrice: 570,
                            commission: 100,
                            commissionPaid: false,
                            address: 'Calle Principal 123, Ciudad',
                            district: 'no',
                            comments: 'Cliente satisfecho con la instalaci√≥n'
                        },
                        {
                            id: 2,
                            name: 'Mar√≠a Gonz√°lez',
                            phone: '5559876543',
                            email: 'maria@example.com',
                            status: 'instalada',
                            seller: '2',
                            captureDate: '2025-07-10',
                            installDate: '2025-07-15',
                            account: '789012',
                            reference: 'REF987654321',
                            serviceType: '2',
                            plan: '2',
                            listPrice: 650,
                            fastPrice: 600,
                            commission: 300,
                            commissionPaid: true,
                            address: 'Avenida Central 456, Ciudad',
                            district: 'si',
                            comments: 'Pendiente de segunda instalaci√≥n'
                        },
                        {
                            id: 3,
                            name: 'Carlos Rodr√≠guez',
                            phone: '5554567890',
                            email: 'carlos@example.com',
                            status: 'pendiente',
                            seller: '3',
                            captureDate: '2025-08-05',
                            account: '345678',
                            reference: 'REF456789123',
                            serviceType: '1',
                            plan: '3',
                            listPrice: 950,
                            fastPrice: 830,
                            commission: 450,
                            commissionPaid: false,
                            address: 'Plaza Mayor 789, Ciudad',
                            district: 'no',
                            comments: 'Esperando documentaci√≥n'
                        }
                    ];
                }
                
                updateClientsTable();
                updateSummaryCards();
            }
            
            function processPastedText() {
                const text = pasteText.value.trim();
                if (!text) {
                    alert('Por favor, pega la informaci√≥n del cliente');
                    return;
                }
                
                const lines = text.split('\n').map(line => line.trim()).filter(line => line);
                
                if (lines.length < 4) {
                    alert('La informaci√≥n pegada no tiene el formato esperado');
                    return;
                }
                
                // Procesar la informaci√≥n
                const clientData = {
                    name: lines[0], // Primera l√≠nea: Nombre
                    email: '',
                    phone: '',
                    address: '',
                    serviceType: '',
                    plan: ''
                };
                
                // Buscar email
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('@') && lines[i].includes('.')) {
                        clientData.email = lines[i];
                        break;
                    }
                }
                
                // Buscar tel√©fono (buscar l√≠nea con n√∫meros)
                for (let i = 0; i < lines.length; i++) {
                    if (/[\d]{10,}/.test(lines[i]) && !lines[i].includes('@')) {
                        clientData.phone = lines[i];
                        break;
                    }
                }
                
                // Buscar direcci√≥n (l√≠neas despu√©s del tel√©fono y antes del plan)
                const phoneIndex = lines.findIndex(line => line === clientData.phone);
                let planIndex = -1;
                
                // Buscar plan
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].toLowerCase().includes('plan') || lines[i].toLowerCase().includes('megas') || lines[i].toLowerCase().includes('mega')) {
                        planIndex = i;
                        break;
                    }
                }
                
                // Extraer direcci√≥n
                if (phoneIndex !== -1 && planIndex !== -1 && planIndex > phoneIndex + 1) {
                    clientData.address = lines.slice(phoneIndex + 1, planIndex).join('\n');
                }
                
                // Extraer informaci√≥n del plan
                if (planIndex !== -1) {
                    const planLine = lines[planIndex];
                    
                    // Determinar tipo de servicio
                    if (planLine.toLowerCase().includes('canal') || planLine.toLowerCase().includes('tv')) {
                        // Buscar el servicio correspondiente
                        const tvService = services.find(s => s.name.toLowerCase().includes('tv'));
                        if (tvService) {
                            clientData.serviceType = tvService.id;
                        }
                    } else {
                        // Buscar servicio de solo internet
                        const internetService = services.find(s => s.name.toLowerCase().includes('internet') && !s.name.toLowerCase().includes('tv'));
                        if (internetService) {
                            clientData.serviceType = internetService.id;
                        }
                    }
                    
                    // Determinar velocidad del plan
                    let planSpeed = null;
                    if (planLine.includes('100')) {
                        planSpeed = 100;
                    } else if (planLine.includes('200')) {
                        planSpeed = 200;
                    } else if (planLine.includes('300')) {
                        planSpeed = 300;
                    } else if (planLine.includes('500')) {
                        planSpeed = 500;
                    } else if (planLine.includes('1200')) {
                        planSpeed = 1200;
                    }
                    
                    // Buscar el plan correspondiente
                    if (planSpeed && clientData.serviceType) {
                        const matchingPlan = plans.find(p => p.speed == planSpeed && p.serviceType == clientData.serviceType);
                        if (matchingPlan) {
                            clientData.plan = matchingPlan.id;
                        }
                    }
                }
                
                // Llenar el formulario con los datos extra√≠dos
                document.getElementById('clientName').value = clientData.name;
                document.getElementById('clientPhone').value = clientData.phone;
                document.getElementById('clientEmail').value = clientData.email;
                document.getElementById('clientAddress').value = clientData.address;
                
                if (clientData.serviceType) {
                    document.getElementById('serviceType').value = clientData.serviceType;
                }
                
                if (clientData.plan) {
                    document.getElementById('clientPlan').value = clientData.plan;
                }
                
                // Actualizar precios si hay plan seleccionado
                if (clientData.serviceType && clientData.plan) {
                    updatePriceInfo();
                }
                
                // Cerrar modal de pegado y abrir modal de cliente
                pasteModal.style.display = 'none';
                currentClientId = null;
                document.getElementById('modalTitle').textContent = 'Nuevo Cliente';
                setActiveTab('info');
                clientModal.style.display = 'flex';
            }
            
            function updateClientsTable() {
                clientsTableBody.innerHTML = '';
                
                if (clients.length === 0) {
                    clientsTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No hay clientes para mostrar</td></tr>';
                    return;
                }
                
                clients.forEach(client => {
                    const row = document.createElement('tr');
                    
                    // Obtener informaci√≥n del vendedor
                    const seller = sellers.find(s => s.id == client.seller);
                    const sellerName = seller ? seller.name : 'N/A';
                    
                    // Obtener informaci√≥n del servicio y plan
                    let planText = '';
                    if (client.serviceType && client.plan) {
                        const service = services.find(s => s.id == client.serviceType);
                        const plan = plans.find(p => p.id == client.plan);
                        
                        if (service && plan) {
                            planText = `${service.name} ${plan.speed} Mbps`;
                        }
                    }
                    
                    // Determinar el texto de comisi√≥n (solo mostrar si el estado es "instalada")
                    let commissionText = '';
                    if (client.status === 'instalada' && client.commission) {
                        commissionText = `$${client.commission}`;
                        if (client.commissionPaid) {
                            commissionText += ' (Pagada)';
                        } else {
                            commissionText += ' (Pendiente)';
                        }
                    }
                    
                    row.innerHTML = `
                        <td>${client.name}</td>
                        <td>${client.phone}</td>
                        <td><span class="chip status-${client.status}">${getStatusText(client.status)}</span></td>
                        <td>${sellerName}</td>
                        <td>${formatDate(client.captureDate)}</td>
                        <td>${planText}</td>
                        <td>${commissionText}</td>
                        <td>
                            <button class="whatsapp-btn" data-id="${client.id}"><i class="fab fa-whatsapp"></i></button>
                            <button class="secondary" data-id="${client.id}"><i class="fas fa-edit"></i></button>
                            <button class="accent" data-id="${client.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    
                    clientsTableBody.appendChild(row);
                });
                
                // Agregar event listeners a los botones
                document.querySelectorAll('.whatsapp-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const clientId = this.getAttribute('data-id');
                        openWhatsappModal(clientId);
                    });
                });
                
                document.querySelectorAll('button.secondary').forEach(btn => {
                    if (!btn.classList.contains('whatsapp-btn')) {
                        btn.addEventListener('click', function() {
                            const clientId = this.getAttribute('data-id');
                            editClient(clientId);
                        });
                    }
                });
                
                document.querySelectorAll('button.accent').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const clientId = this.getAttribute('data-id');
                        deleteClient(clientId);
                    });
                });
            }
            
            function updateSummaryCards() {
                document.getElementById('totalClients').textContent = clients.length;
                
                const pendingInstall = clients.filter(client => 
                    ['instalar', 'transito', 'trabajando'].includes(client.status)
                ).length;
                document.getElementById('pendingInstall').textContent = pendingInstall;
                
                const today = new Date();
                const month = today.getMonth() + 1;
                const year = today.getFullYear();
                
                const monthlyInstall = clients.filter(client => {
                    if (client.installDate) {
                        const installDate = new Date(client.installDate);
                        return installDate.getMonth() + 1 === month && 
                               installDate.getFullYear() === year &&
                               client.status === 'instalada';
                    }
                    return false;
                }).length;
                document.getElementById('monthlyInstall').textContent = monthlyInstall;
                
                // Comisiones pendientes (solo instaladas y no pagadas)
                const pendingCommissions = clients.reduce((total, client) => {
                    if (client.commission && client.status === 'instalada' && !client.commissionPaid) {
                        return total + client.commission;
                    }
                    return total;
                }, 0);
                document.getElementById('pendingCommissions').textContent = `$${pendingCommissions}`;
                
                // Comisiones pagadas
                const paidCommissions = clients.reduce((total, client) => {
                    if (client.commission && client.commissionPaid) {
                        return total + client.commission;
                    }
                    return total;
                }, 0);
                document.getElementById('paidCommissions').textContent = `$${paidCommissions}`;
            }
            
            function getStatusText(status) {
                const statusMap = {
                    'prospecto': 'Prospecto',
                    'interesado': 'Interesado',
                    'pendiente': 'Pendiente doc',
                    'instalar': 'Por instalar',
                    'transito': 'En tr√°nsito',
                    'trabajando': 'Trabajando',
                    'instalada': 'Instalada',
                    'perdida': 'Perdida',
                    'cobertura': 'Sin cobertura',
                    'factibilidad': 'Factibilidad',
                    'planta': 'Planta Externa'
                };
                
                return statusMap[status] || status;
            }
            
            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES');
            }
            
            function openWhatsappModal(clientId) {
                const client = clients.find(c => c.id == clientId);
                if (client) {
                    currentClientForWhatsapp = clientId;
                    updateWhatsappPreview();
                    whatsappModal.style.display = 'flex';
                }
            }
            
            function updateWhatsappPreview() {
                if (!currentClientForWhatsapp) return;
                
                const client = clients.find(c => c.id == currentClientForWhatsapp);
                if (client) {
                    const templateType = whatsappTemplate.value;
                    let message = whatsappTemplates[templateType];
                    
                    // Personalizar el mensaje
                    message = message.replace('[Nombre]', client.name);
                    message = message.replace('[Referencia]', client.reference || 'N/A');
                    
                    whatsappPreview.textContent = message;
                }
            }
            
            function cleanPhoneNumber(phone) {
                // Eliminar cualquier car√°cter que no sea n√∫mero
                return phone.replace(/\D/g, '');
            }
            
            function updatePriceInfo() {
                const selectedService = serviceType.value;
                const selectedPlan = clientPlan.value;
                
                if (selectedService && selectedPlan) {
                    priceInfo.style.display = 'block';
                    
                    // Limpiar tabla de precios
                    priceInfoBody.innerHTML = '';
                    
                    // Buscar informaci√≥n del plan seleccionado
                    const plan = plans.find(p => p.id == selectedPlan);
                    if (plan) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${plan.name} (${plan.speed} Mbps)</td>
                            <td>$${plan.fastPrice}</td>
                            <td>$${plan.listPrice}</td>
                            <td>$${plan.commission}</td>
                        `;
                        priceInfoBody.appendChild(row);
                        
                        // Actualizar campos de precio
                        clientListPrice.value = plan.listPrice;
                        clientFastPrice.value = plan.fastPrice;
                        clientCommission.value = plan.commission;
                    }
                } else {
                    priceInfo.style.display = 'none';
                }
            }
            
            function togglePriceFields() {
                const status = clientStatus.value;
                
                if (status === 'instalada') {
                    priceFields.style.display = 'block';
                    commissionPaidSection.style.display = 'flex';
                } else {
                    priceFields.style.display = 'none';
                    commissionPaidSection.style.display = 'none';
                }
            }
            
            function editClient(clientId) {
                const client = clients.find(c => c.id == clientId);
                if (client) {
                    currentClientId = clientId;
                    document.getElementById('modalTitle').textContent = 'Editar Cliente';
                    
                    // Llenar el formulario con los datos del cliente
                    document.getElementById('clientName').value = client.name || '';
                    document.getElementById('clientPhone').value = client.phone || '';
                    document.getElementById('clientAdditionalPhone').value = client.additionalPhone || '';
                    document.getElementById('clientEmail').value = client.email || '';
                    document.getElementById('clientAddress').value = client.address || '';
                    document.getElementById('clientStatus').value = client.status || 'prospecto';
                    document.getElementById('serviceType').value = client.serviceType || '';
                    document.getElementById('clientPlan').value = client.plan || '';
                    document.getElementById('clientListPrice').value = client.listPrice || '';
                    document.getElementById('clientFastPrice').value = client.fastPrice || '';
                    document.getElementById('clientCommission').value = client.commission || '';
                    document.getElementById('clientAccount').value = client.account || '';
                    document.getElementById('clientReference').value = client.reference || '';
                    document.getElementById('clientCaptureDate').value = client.captureDate || '';
                    document.getElementById('clientInstallDate').value = client.installDate || '';
                    document.getElementById('clientDistrict').value = client.district || 'no';
                    document.getElementById('clientSeller').value = client.seller || '';
                    document.getElementById('clientComments').value = client.comments || '';
                    document.getElementById('commissionPaid').checked = client.commissionPaid || false;
                    
                    // Actualizar informaci√≥n de precios
                    updatePriceInfo();
                    togglePriceFields();
                    
                    setActiveTab('info');
                    clientModal.style.display = 'flex';
                }
            }
            
            function deleteClient(clientId) {
                if (confirm('¬øEst√°s seguro de que quieres eliminar este cliente?')) {
                    const client = clients.find(c => c.id == clientId);
                    clients = clients.filter(client => client.id != clientId);
                    updateClientsTable();
                    updateSummaryCards();
                    saveToLocalStorage();
                    
                    // Sincronizar con Make.com
                    syncWithMake('delete_client', client);
                    
                    showNotification('Cliente eliminado correctamente', 'success');
                }
            }
            
            function saveClient() {
                const clientData = {
                    name: document.getElementById('clientName').value,
                    phone: document.getElementById('clientPhone').value,
                    additionalPhone: document.getElementById('clientAdditionalPhone').value,
                    email: document.getElementById('clientEmail').value,
                    address: document.getElementById('clientAddress').value,
                    status: document.getElementById('clientStatus').value,
                    serviceType: document.getElementById('serviceType').value,
                    plan: document.getElementById('clientPlan').value,
                    listPrice: document.getElementById('clientListPrice').value ? parseFloat(document.getElementById('clientListPrice').value) : null,
                    fastPrice: document.getElementById('clientFastPrice').value ? parseFloat(document.getElementById('clientFastPrice').value) : null,
                    commission: document.getElementById('clientCommission').value ? parseFloat(document.getElementById('clientCommission').value) : null,
                    account: document.getElementById('clientAccount').value,
                    reference: document.getElementById('clientReference').value,
                    captureDate: document.getElementById('clientCaptureDate').value,
                    installDate: document.getElementById('clientInstallDate').value,
                    district: document.getElementById('clientDistrict').value,
                    seller: document.getElementById('clientSeller').value,
                    comments: document.getElementById('clientComments').value,
                    commissionPaid: document.getElementById('commissionPaid').checked
                };
                
                if (currentClientId) {
                    // Editar cliente existente
                    const index = clients.findIndex(client => client.id == currentClientId);
                    if (index !== -1) {
                        clients[index] = { ...clients[index], ...clientData };
                        // Sincronizar con Make.com
                        syncWithMake('update_client', clients[index]);
                    }
                } else {
                    // Nuevo cliente
                    const newId = clients.length > 0 ? Math.max(...clients.map(c => c.id)) + 1 : 1;
                    const newClient = { id: newId, ...clientData };
                    clients.push(newClient);
                    // Sincronizar con Make.com
                    syncWithMake('add_client', newClient);
                }
                
                updateClientsTable();
                updateSummaryCards();
                saveToLocalStorage();
                clientModal.style.display = 'none';
                
                showNotification('Cliente guardado correctamente', 'success');
            }
            
            function filterClients() {
                const status = statusFilter.value;
                const seller = sellerFilter.value;
                const date = dateFilter.value;
                const commissionStatus = commissionFilter.value;
                const search = searchFilter.value.toLowerCase();
                
                let filteredClients = clients;
                
                if (status) {
                    filteredClients = filteredClients.filter(client => client.status === status);
                }
                
                if (seller) {
                    filteredClients = filteredClients.filter(client => client.seller === seller);
                }
                
                if (date) {
                    filteredClients = filteredClients.filter(client => {
                        if (!client.captureDate) return false;
                        return client.captureDate.startsWith(date);
                    });
                }
                
                if (commissionStatus) {
                    if (commissionStatus === 'pendiente') {
                        filteredClients = filteredClients.filter(client => 
                            client.status === 'instalada' && !client.commissionPaid
                        );
                    } else if (commissionStatus === 'pagada') {
                        filteredClients = filteredClients.filter(client => client.commissionPaid);
                    }
                }
                
                if (search) {
                    filteredClients = filteredClients.filter(client => 
                        client.name.toLowerCase().includes(search) || 
                        (client.phone && client.phone.includes(search)) ||
                        (client.account && client.account.includes(search)) ||
                        (client.address && client.address.toLowerCase().includes(search))
                    );
                }
                
                // Actualizar tabla con clientes filtrados
                clientsTableBody.innerHTML = '';
                
                if (filteredClients.length === 0) {
                    clientsTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No hay clientes que coincidan con los filtros</td></tr>';
                    return;
                }
                
                filteredClients.forEach(client => {
                    const row = document.createElement('tr');
                    
                    // Obtener informaci√≥n del vendedor
                    const seller = sellers.find(s => s.id == client.seller);
                    const sellerName = seller ? seller.name : 'N/A';
                    
                    // Obtener informaci√≥n del servicio y plan
                    let planText = '';
                    if (client.serviceType && client.plan) {
                        const service = services.find(s => s.id == client.serviceType);
                        const plan = plans.find(p => p.id == client.plan);
                        
                        if (service && plan) {
                            planText = `${service.name} ${plan.speed} Mbps`;
                        }
                    }
                    
                    // Determinar el texto de comisi√≥n (solo mostrar si el estado es "instalada")
                    let commissionText = '';
                    if (client.status === 'instalada' && client.commission) {
                        commissionText = `$${client.commission}`;
                        if (client.commissionPaid) {
                            commissionText += ' (Pagada)';
                        } else {
                            commissionText += ' (Pendiente)';
                        }
                    }
                    
                    row.innerHTML = `
                        <td>${client.name}</td>
                        <td>${client.phone}</td>
                        <td><span class="chip status-${client.status}">${getStatusText(client.status)}</span></td>
                        <td>${sellerName}</td>
                        <td>${formatDate(client.captureDate)}</td>
                        <td>${planText}</td>
                        <td>${commissionText}</td>
                        <td>
                            <button class="whatsapp-btn" data-id="${client.id}"><i class="fab fa-whatsapp"></i></button>
                            <button class="secondary" data-id="${client.id}"><i class="fas fa-edit"></i></button>
                            <button class="accent" data-id="${client.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    
                    clientsTableBody.appendChild(row);
                });
                
                // Agregar event listeners a los botones de la tabla filtrada
                document.querySelectorAll('.whatsapp-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const clientId = this.getAttribute('data-id');
                        openWhatsappModal(clientId);
                    });
                });
                
                document.querySelectorAll('button.secondary').forEach(btn => {
                    if (!btn.classList.contains('whatsapp-btn')) {
                        btn.addEventListener('click', function() {
                            const clientId = this.getAttribute('data-id');
                            editClient(clientId);
                        });
                    }
                });
                
                document.querySelectorAll('button.accent').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const clientId = this.getAttribute('data-id');
                        deleteClient(clientId);
                    });
                });
            }
            
            function syncWithMake(action = 'full_sync', specificData = null) {
                updateSyncStatus('syncing', 'Sincronizando...');
                
                let syncData = {
                    action: action,
                    timestamp: new Date().toISOString(),
                    operationId: 'op_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
                };

                // Funci√≥n para formatear fecha de YYYY-MM-DD a DD/MM/YYYY
                function formatDateForSheets(dateString) {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                }

                // Funci√≥n para obtener nombre del vendedor
                function getSellerName(sellerId) {
                    if (!sellerId) return '';
                    const seller = sellers.find(s => s.id == sellerId);
                    return seller ? seller.name : '';
                }

                // Funci√≥n para obtener nombre del plan
                function getPlanName(planId) {
                    if (!planId) return '';
                    const plan = plans.find(p => p.id == planId);
                    return plan ? `${plan.name} (${plan.speed} Mbps)` : '';
                }

                // Funci√≥n para obtener nombre del servicio
                function getServiceName(serviceId) {
                    if (!serviceId) return '';
                    const service = services.find(s => s.id == serviceId);
                    return service ? service.name : '';
                }

                if (action === 'full_sync') {
                    // Enviar datos en el formato que Make.com espera
                    syncData.clients = clients.map(client => {
                        return {
                            // Formato corregido para el mapeo en Make.com
                            id: client.id,
                            name: client.name,
                            email: client.email || '',
                            phone: client.phone,
                            status: client.status, // Mantener el valor original (min√∫sculas)
                            sellerName: getSellerName(client.seller),
                            captureDate: formatDateForSheets(client.captureDate), // Formatear fecha
                            planName: getPlanName(client.plan),
                            listPrice: client.listPrice || '',
                            fastPrice: client.fastPrice || '',
                            commission: client.commission || '',
                            installDate: formatDateForSheets(client.installDate), // Formatear fecha
                            commissionPaid: client.commissionPaid ? 'S√≠' : 'No', // Convertir a S√≠/No
                            reference: client.reference || '',
                            address: client.address || '',
                            district: client.district === 'si' ? 'S√≠' : 'No',
                            comments: client.comments || '',
                            additionalPhone: client.additionalPhone || '',
                            account: client.account || '',
                            serviceType: getServiceName(client.serviceType) // Mostrar nombre en lugar de ID
                        };
                    });
                } else if (specificData) {
                    // Para acciones individuales
                    syncData.client = {
                        id: specificData.id,
                        name: specificData.name,
                        email: specificData.email || '',
                        phone: specificData.phone,
                        status: specificData.status, // Mantener el valor original (min√∫sculas)
                        sellerName: getSellerName(specificData.seller),
                        captureDate: formatDateForSheets(specificData.captureDate), // Formatear fecha
                        planName: getPlanName(specificData.plan),
                        listPrice: specificData.listPrice || '',
                        fastPrice: specificData.fastPrice || '',
                        commission: specificData.commission || '',
                        installDate: formatDateForSheets(specificData.installDate), // Formatear fecha
                        commissionPaid: specificData.commissionPaid ? 'S√≠' : 'No', // Convertir a S√≠/No
                        reference: specificData.reference || '',
                        address: specificData.address || '',
                        district: specificData.district === 'si' ? 'S√≠' : 'No',
                        comments: specificData.comments || '',
                        additionalPhone: specificData.additionalPhone || '',
                        account: specificData.account || '',
                        serviceType: getServiceName(specificData.serviceType) // Mostrar nombre en lugar de ID
                    };
                }
                
                // Enviar datos a Make.com
                fetch(makeWebhook, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(syncData)
                })
                .then(async response => {
                    const responseText = await response.text();
                    
                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }
                    
                    try {
                        return JSON.parse(responseText);
                    } catch (e) {
                        return { success: true, message: responseText };
                    }
                })
                .then(data => {
                    if (data && (data.success === true || data.status === 'success')) {
                        updateSyncStatus('connected', 'Sincronizado');
                        showNotification('Datos sincronizados correctamente con Make.com', 'success');
                        lastSyncStatus = 'success';
                    } else {
                        updateSyncStatus('connected', 'Sincronizado');
                        showNotification('Sincronizaci√≥n completada', 'success');
                        lastSyncStatus = 'success';
                    }
                })
                .catch(error => {
                    console.error('Error sincronizando con Make.com:', error);
                    updateSyncStatus('disconnected', 'Error de sincronizaci√≥n');
                    showNotification(`Error al sincronizar: ${error.message}`, 'error');
                    lastSyncStatus = 'error';
                });
            }
            
            function updateSyncStatus(status, message) {
                // Actualizar la interfaz con el estado de sincronizaci√≥n
                const statusElement = document.getElementById('makeStatusText');
                if (statusElement) {
                    statusElement.textContent = message;
                    
                    // Cambiar color seg√∫n el estado
                    if (status === 'connected') {
                        statusElement.style.color = 'green';
                    } else if (status === 'syncing') {
                        statusElement.style.color = 'orange';
                    } else if (status === 'disconnected') {
                        statusElement.style.color = 'red';
                    }
                }
            }
            
            function exportData() {
                // Crear contenido CSV
                let csvContent = "Nombre,Correo,Tel√©fono,Estado,Vendedor,Fecha Captura,Plan,Precio Lista,Precio Pronto Pago,Comisi√≥n,Fecha Instalada,Comisi√≥n Pagada,Referencia,Direcci√≥n,¬øEs Distrito?\n";
                
                clients.forEach(client => {
                    // Obtener informaci√≥n del vendedor
                    const seller = sellers.find(s => s.id == client.seller);
                    const sellerName = seller ? seller.name : 'N/A';
                    
                    // Obtener informaci√≥n del servicio y plan
                    let planText = '';
                    if (client.serviceType && client.plan) {
                        const service = services.find(s => s.id == client.serviceType);
                        const plan = plans.find(p => p.id == client.plan);
                        
                        if (service && plan) {
                            planText = `${service.name} ${plan.speed} Mbps`;
                        }
                    }
                    
                    csvContent += `"${client.name}",${client.email || ''},${client.phone},${getStatusText(client.status)},${sellerName},${client.captureDate || ''},"${planText}",${client.listPrice || ''},${client.fastPrice || ''},${client.commission || ''},${client.installDate || ''},${client.commissionPaid ? 'S√≠' : 'No'},${client.reference || ''},"${client.address || ''}",${client.district || 'No'}\n`;
                });
                
                // Crear blob y descargar
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "clientes.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('Datos exportados correctamente', 'success');
            }
            
            function saveToLocalStorage() {
                // Guardar datos en localStorage
                localStorage.setItem('crm-clients', JSON.stringify(clients));
                localStorage.setItem('crm-sellers', JSON.stringify(sellers));
                localStorage.setItem('crm-services', JSON.stringify(services));
                localStorage.setItem('crm-plans', JSON.stringify(plans));
                localStorage.setItem('crm-make-webhook', makeWebhook);
            }
            
            function loadFromLocalStorage() {
                // Cargar datos desde localStorage
                const savedClients = localStorage.getItem('crm-clients');
                const savedSellers = localStorage.getItem('crm-sellers');
                const savedServices = localStorage.getItem('crm-services');
                const savedPlans = localStorage.getItem('crm-plans');
                const savedMakeWebhook = localStorage.getItem('crm-make-webhook');
                
                if (savedClients) {
                    clients = JSON.parse(savedClients);
                }
                
                if (savedSellers) {
                    sellers = JSON.parse(savedSellers);
                } else {
                    // Datos predeterminados de vendedores
                    sellers = [
                        { id: '1', name: 'Juan P√©rez', phone: '555-123-4567' },
                        { id: '2', name: 'Mar√≠a Garc√≠a', phone: '555-987-6543' },
                        { id: '3', name: 'Carlos L√≥pez', phone: '555-456-7890' },
                        { id: '4', name: 'Ana Rodr√≠guez', phone: '555-111-2233' }
                    ];
                }
                
                if (savedServices) {
                    services = JSON.parse(savedServices);
                } else {
                    // Datos predeterminados de servicios
                    services = [
                        { id: '1', name: 'Solo Internet' },
                        { id: '2', name: 'Internet + TV' }
                    ];
                }
                
                if (savedPlans) {
                    plans = JSON.parse(savedPlans);
                } else {
                    // Datos predeterminados de planes
                    plans = [
                        { id: '1', name: 'B√°sico', speed: 100, serviceType: '1', fastPrice: 460, listPrice: 510, commission: 60 },
                        { id: '2', name: 'B√°sico TV', speed: 100, serviceType: '2', fastPrice: 600, listPrice: 650, commission: 300 },
                        { id: '3', name: 'Avanzado', speed: 200, serviceType: '1', fastPrice: 570, listPrice: 620, commission: 100 },
                        { id: '4', name: 'Avanzado TV', speed: 200, serviceType: '2', fastPrice: 710, listPrice: 760, commission: 600 },
                        { id: '5', name: 'Premium', speed: 300, serviceType: '1', fastPrice: 680, listPrice: 730, commission: 200 },
                        { id: '6', name: 'Premium TV', speed: 300, serviceType: '2', fastPrice: 820, listPrice: 870, commission: 850 },
                        { id: '7', name: 'Ultra', speed: 500, serviceType: '1', fastPrice: 830, listPrice: 950, commission: 450 },
                        { id: '8', name: 'Ultra TV', speed: 500, serviceType: '2', fastPrice: 1000, listPrice: 1120, commission: 1100 },
                        { id: '9', name: 'M√°ximo', speed: 1200, serviceType: '1', fastPrice: 1470, listPrice: 1590, commission: 750 },
                        { id: '10', name: 'M√°ximo TV', speed: 1200, serviceType: '2', fastPrice: 1640, listPrice: 1760, commission: 1500 }
                    ];
                }
                
                if (savedMakeWebhook) {
                    makeWebhook = savedMakeWebhook;
                }
            }
            
            function hideAllSections() {
                const sections = document.querySelectorAll('.management-section');
                sections.forEach(section => {
                    section.style.display = 'none';
                });
            }
            
            function loadSellersList() {
                sellersList.innerHTML = '';
                
                sellers.forEach(seller => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div>
                            <strong>${seller.name</strong>
                            <br>
                            <span>${seller.phone}</span>
                        </div>
                        <div class="management-actions">
                            <button class="secondary edit-seller" data-id="${seller.id}"><i class="fas fa-edit"></i></button>
                            <button class="accent delete-seller" data-id="${seller.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    sellersList.appendChild(li);
                });
                
                // Agregar event listeners a los botones
                document.querySelectorAll('.edit-seller').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const sellerId = this.getAttribute('data-id');
                        editSeller(sellerId);
                    });
                });
                
                document.querySelectorAll('.delete-seller').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const sellerId = this.getAttribute('data-id');
                        deleteSeller(sellerId);
                    });
                });
            }
            
            function addOrUpdateSeller() {
                const name = sellerName.value.trim();
                const phone = sellerPhone.value.trim();
                
                if (!name) {
                    alert('Por favor, ingresa el nombre del vendedor');
                    return;
                }
                
                if (currentEditingSeller) {
                    // Editar vendedor existente
                    const seller = sellers.find(s => s.id == currentEditingSeller);
                    if (seller) {
                        seller.name = name;
                        seller.phone = phone;
                    }
                    currentEditingSeller = null;
                    addSellerBtn.innerHTML = '<i class="fas fa-plus"></i> Agregar Vendedor';
                } else {
                    // Agregar nuevo vendedor
                    const newId = sellers.length > 0 ? Math.max(...sellers.map(s => parseInt(s.id))) + 1 : 1;
                    sellers.push({
                        id: newId.toString(),
                        name: name,
                        phone: phone
                    });
                }
                
                // Limpiar formulario
                sellerName.value = '';
                sellerPhone.value = '';
                
                // Actualizar lista y selectores
                loadSellersList();
                loadSellers();
                saveToLocalStorage();
                
                showNotification('Vendedor guardado correctamente', 'success');
            }
            
            function editSeller(sellerId) {
                const seller = sellers.find(s => s.id == sellerId);
                if (seller) {
                    sellerName.value = seller.name;
                    sellerPhone.value = seller.phone;
                    currentEditingSeller = sellerId;
                    addSellerBtn.innerHTML = '<i class="fas fa-save"></i> Actualizar Vendedor';
                }
            }
            
            function deleteSeller(sellerId) {
                if (confirm('¬øEst√°s seguro de que quieres eliminar este vendedor?')) {
                    // Verificar si el vendedor est√° asignado a alg√∫n cliente
                    const assignedClients = clients.filter(client => client.seller == sellerId);
                    
                    if (assignedClients.length > 0) {
                        alert('No se puede eliminar este vendedor porque est√° asignado a ' + assignedClients.length + ' cliente(s). Reasigna los clientes primero.');
                        return;
                    }
                    
                    sellers = sellers.filter(seller => seller.id != sellerId);
                    loadSellersList();
                    loadSellers();
                    saveToLocalStorage();
                    
                    showNotification('Vendedor eliminado correctamente', 'success');
                }
            }
            
            function loadServicesList() {
                servicesList.innerHTML = '';
                
                services.forEach(service => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div>
                            <strong>${service.name}</strong>
                        </div>
                        <div class="management-actions">
                            <button class="secondary edit-service" data-id="${service.id}"><i class="fas fa-edit"></i></button>
                            <button class="accent delete-service" data-id="${service.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    servicesList.appendChild(li);
                });
                
                // Agregar event listeners a los botones
                document.querySelectorAll('.edit-service').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const serviceId = this.getAttribute('data-id');
                        editService(serviceId);
                    });
                });
                
                document.querySelectorAll('.delete-service').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const serviceId = this.getAttribute('data-id');
                        deleteService(serviceId);
                    });
                });
            }
            
            function addOrUpdateService() {
                const name = serviceName.value.trim();
                
                if (!name) {
                    alert('Por favor, ingresa el nombre del servicio');
                    return;
                }
                
                if (currentEditingService) {
                    // Editar servicio existente
                    const service = services.find(s => s.id == currentEditingService);
                    if (service) {
                        service.name = name;
                    }
                    currentEditingService = null;
                    addServiceBtn.innerHTML = '<i class="fas fa-plus"></i> Agregar Servicio';
                } else {
                    // Agregar nuevo servicio
                    const newId = services.length > 0 ? Math.max(...sellers.map(s => parseInt(s.id))) + 1 : 1;
                    services.push({
                        id: newId.toString(),
                        name: name
                    });
                }
                
                // Limpiar formulario
                serviceName.value = '';
                
                // Actualizar lista y selectores
                loadServicesList();
                updateServiceOptions();
                updatePlanServiceTypeOptions();
                saveToLocalStorage();
                
                showNotification('Servicio guardado correctamente', 'success');
            }
            
            function editService(serviceId) {
                const service = services.find(s => s.id == serviceId);
                if (service) {
                    serviceName.value = service.name;
                    currentEditingService = serviceId;
                    addServiceBtn.innerHTML = '<i class="fas fa-save"></i> Actualizar Servicio';
                }
            }
            
            function deleteService(serviceId) {
                if (confirm('¬øEst√°s seguro de que quieres eliminar este servicio?')) {
                    // Verificar si el servicio est√° asignado a alg√∫n cliente o plan
                    const assignedClients = clients.filter(client => client.serviceType == serviceId);
                    const assignedPlans = plans.filter(plan => plan.serviceType == serviceId);
                    
                    if (assignedClients.length > 0 || assignedPlans.length > 0) {
                        alert('No se puede eliminar este servicio porque est√° asignado a ' + assignedClients.length + ' cliente(s) y ' + assignedPlans.length + ' plan(es). Reasigna primero.');
                        return;
                    }
                    
                    services = services.filter(service => service.id != serviceId);
                    loadServicesList();
                    updateServiceOptions();
                    updatePlanServiceTypeOptions();
                    saveToLocalStorage();
                    
                    showNotification('Servicio eliminado correctamente', 'success');
                }
            }
            
            function loadPlansList() {
                plansList.innerHTML = '';
                
                plans.forEach(plan => {
                    const service = services.find(s => s.id == plan.serviceType);
                    const serviceName = service ? service.name : 'N/A';
                    
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div>
                            <strong>${plan.name} (${plan.speed} Mbps)</strong>
                            <br>
                            <span>Servicio: ${serviceName}</span>
                            <br>
                            <span>P. Pronto Pago: $${plan.fastPrice} | P. Lista: $${plan.listPrice} | Comisi√≥n: $${plan.commission}</span>
                        </div>
                        <div class="management-actions">
                            <button class="secondary edit-plan" data-id="${plan.id}"><i class="fas fa-edit"></i></button>
                            <button class="accent delete-plan" data-id="${plan.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    plansList.appendChild(li);
                });
                
                // Agregar event listeners a los botones
                document.querySelectorAll('.edit-plan').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const planId = this.getAttribute('data-id');
                        editPlan(planId);
                    });
                });
                
                document.querySelectorAll('.delete-plan').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const planId = this.getAttribute('data-id');
                        deletePlan(planId);
                    });
                });
            }
            
            function addOrUpdatePlan() {
                const name = planName.value.trim();
                const speed = parseInt(planSpeed.value);
                const serviceType = planServiceType.value;
                const fastPrice = parseFloat(planFastPrice.value);
                const listPrice = parseFloat(planListPrice.value);
                const commission = parseFloat(planCommission.value);
                
                if (!name || !speed || !serviceType || !fastPrice || !listPrice || !commission) {
                    alert('Por favor, completa todos los campos del plan');
                    return;
                }
                
                if (currentEditingPlan) {
                    // Editar plan existente
                    const plan = plans.find(p => p.id == currentEditingPlan);
                    if (plan) {
                        plan.name = name;
                        plan.speed = speed;
                        plan.serviceType = serviceType;
                        plan.fastPrice = fastPrice;
                        plan.listPrice = listPrice;
                        plan.commission = commission;
                    }
                    currentEditingPlan = null;
                    addPlanBtn.innerHTML = '<i class="fas fa-plus"></i> Agregar Plan';
                } else {
                    // Agregar nuevo plan
                    const newId = plans.length > 0 ? Math.max(...plans.map(p => parseInt(p.id))) + 1 : 1;
                    plans.push({
                        id: newId.toString(),
                        name: name,
                        speed: speed,
                        serviceType: serviceType,
                        fastPrice: fastPrice,
                        listPrice: listPrice,
                        commission: commission
                    });
                }
                
                // Limpiar formulario
                planName.value = '';
                planSpeed.value = '';
                planServiceType.value = '';
                planFastPrice.value = '';
                planListPrice.value = '';
                planCommission.value = '';
                
                // Actualizar lista y selectores
                loadPlansList();
                updatePricingTable();
                loadPlans();
                saveToLocalStorage();
                
                showNotification('Plan guardado correctamente', 'success');
            }
            
            function editPlan(planId) {
                const plan = plans.find(p => p.id == planId);
                if (plan) {
                    planName.value = plan.name;
                    planSpeed.value = plan.speed;
                    planServiceType.value = plan.serviceType;
                    planFastPrice.value = plan.fastPrice;
                    planListPrice.value = plan.listPrice;
                    planCommission.value = plan.commission;
                    currentEditingPlan = planId;
                    addPlanBtn.innerHTML = '<i class="fas fa-save"></i> Actualizar Plan';
                }
            }
            
            function deletePlan(planId) {
                if (confirm('¬øEst√°s seguro de que quieres eliminar este plan?')) {
                    // Verificar si el plan est√° asignado a alg√∫n cliente
                    const assignedClients = clients.filter(client => client.plan == planId);
                    
                    if (assignedClients.length > 0) {
                        alert('No se puede eliminar este plan porque est√° asignado a ' + assignedClients.length + ' cliente(s). Reasigna primero.');
                        return;
                    }
                    
                    plans = plans.filter(plan => plan.id != planId);
                    loadPlansList();
                    updatePricingTable();
                    loadPlans();
                    saveToLocalStorage();
                    
                    showNotification('Plan eliminado correctamente', 'success');
                }
            }
            
            function loadMakeConfig() {
                makeWebhookUrl.value = makeWebhook;
                currentWebhookUrl.textContent = makeWebhook;
                makeStatusText.textContent = 'Conectado';
                makeStatusText.style.color = 'green';
            }
            
            function saveMakeConfig() {
                const webhookUrl = makeWebhookUrl.value.trim();
                
                if (!webhookUrl) {
                    alert('Por favor, ingresa la URL del webhook de Make.com');
                    return;
                }
                
                makeWebhook = webhookUrl;
                
                saveToLocalStorage();
                loadMakeConfig();
                
                showNotification('Configuraci√≥n de Make.com actualizada correctamente', 'success');
            }
            
            function testMakeConnection() {
                showNotification('Probando conexi√≥n con Make.com...', 'success');
                
                // Enviar una solicitud de prueba
                fetch(makeWebhook, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'test',
                        message: 'Conexi√≥n de prueba desde CRM',
                        timestamp: new Date().toISOString()
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }
                    return response.json();
                })
                .then(data => {
                    showNotification('Conexi√≥n exitosa con Make.com', 'success');
                })
                .catch(error => {
                    console.error('Error probando conexi√≥n con Make.com:', error);
                    showNotification('Error al conectar con Make.com. Verifica la URL del webhook.', 'error');
                });
            }
            
            function importFromSheets() {
                showNotification('Solicitando datos desde Google Sheets...', 'success');
                
                // Enviar solicitud de importaci√≥n
                fetch(makeWebhook, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'import_data',
                        timestamp: new Date().toISOString()
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.clients && Array.isArray(data.clients)) {
                        clients = data.clients;
                        updateClientsTable();
                        updateSummaryCards();
                        saveToLocalStorage();
                        showNotification('Datos importados correctamente desde Google Sheets', 'success');
                    } else {
                        showNotification('No se recibieron datos v√°lidos desde Google Sheets', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error importando desde Google Sheets:', error);
                    showNotification('Error al importar desde Google Sheets. Verifica la configuraci√≥n en Make.com.', 'error');
                });
            }
            
            function showNotification(message, type) {
                notification.textContent = message;
                notification.className = 'notification ' + type;
                notification.style.display = 'block';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        });
    </script>
</body>
</html>